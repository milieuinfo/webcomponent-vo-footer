version: "3"
services:
  selenium-hub:
    image: ${DOCKER_REGISTRY}selenium/hub:4.2.1-20220531
    container_name: selenium-hub
    networks:
      - test-network
    ports:
      - '4444:4444'
      - '4443:4443'
      - '4442:4442'
  selenium-chrome:
    image: ${DOCKER_REGISTRY}selenium/node-chrome:102.0-20220531
    depends_on:
      - selenium-hub
    networks:
      - test-network
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - http_proxy=${http_proxy}
      - https_proxy=${https_proxy}
      - no_proxy=${no_proxy},selenium-hub,tests
  selenium-firefox:
    image: ${DOCKER_REGISTRY}selenium/node-firefox:100.0.2-20220531
    depends_on:
      - selenium-hub
    networks:
      - test-network
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - http_proxy=${http_proxy}
      - https_proxy=${https_proxy}
      - no_proxy=${no_proxy},selenium-hub,tests
  tests:
    image: ${DOCKER_REGISTRY}node:10
    depends_on:
      - selenium-hub
      - selenium-chrome
      - selenium-firefox
    working_dir: /workdir
    networks:
      - test-network
    volumes:
      - ${HOME:-.}/.npmrc:/root/.npmrc:ro
      - ${HOME:-.}/.gitconfig:/root/.gitconfig:ro
      - ${HOME:-.}/.git-credentials:/root/.git-credentials:ro
      - ..:/data:ro
      - ./wct.docker.conf.js:/workdir/wct.conf.js:ro
    command: bash -c "cp -R /data/. /workdir && npm install && npm run test"
networks:
  test-network:
    driver: bridge
